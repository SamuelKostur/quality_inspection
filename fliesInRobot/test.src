&ACCESS RVP
&REL 9
DEF test()
   decl axis joint_pos_tgt
   decl int elements_read  

   bas(#initmov, 0)  ; Basic initializasion of axes
   $VEL_AXIS[1] = 1
   $VEL_AXIS[2] = 1
   $VEL_AXIS[3] = 1
   $VEL_AXIS[4] = 1
   $VEL_AXIS[5] = 1
   $VEL_AXIS[6] = 1
   eki_hw_iface_init()
   
   joint_pos_tgt = $axis_act_meas
   ptp joint_pos_tgt

   $advance = 5
   loop      
      WAIT FOR $FLAG[2] 
      elements_read = eki_hw_iface_get(joint_pos_tgt)  ; Get new command from buffer if present      
      $FLAG[2] = FALSE      
      ptp joint_pos_tgt c_ptp                          ; PTP to most recent commanded position      
      eki_hw_iface_send()                              ; Send measured robot pose to PC
   endloop

end

def eki_hw_iface_init()
   decl eki_status eki_ret
      
   wait sec 0.012          ; Wait for next interpolation cycle

   ; Create and open EKI interface
   eki_ret = eki_init("EkiHwInterface")
   eki_ret = eki_open("EkiHwInterface")
end

deffct int eki_hw_iface_get(joint_pos_cmd :out)
   decl eki_status eki_ret
   decl axis joint_pos_cmd

   if not $flag[1] then
      return 0
   endif

   eki_ret = eki_checkbuffer("EkiHwInterface", "RobotCommand/Pos/@A1")
   if eki_ret.buff <= 0 then
     return 0
   endif

   eki_ret = eki_getreal("EkiHwInterface", "RobotCommand/Pos/@A1", joint_pos_cmd.a1)
   eki_ret = eki_getreal("EkiHwInterface", "RobotCommand/Pos/@A2", joint_pos_cmd.a2)
   eki_ret = eki_getreal("EkiHwInterface", "RobotCommand/Pos/@A3", joint_pos_cmd.a3)
   eki_ret = eki_getreal("EkiHwInterface", "RobotCommand/Pos/@A4", joint_pos_cmd.a4)
   eki_ret = eki_getreal("EkiHwInterface", "RobotCommand/Pos/@A5", joint_pos_cmd.a5)
   eki_ret = eki_getreal("EkiHwInterface", "RobotCommand/Pos/@A6", joint_pos_cmd.a6)
   return 1
endfct

def eki_hw_iface_send()
   decl eki_status eki_ret

   if $flag[1] then  ; If connection alive
      ; Load state values into xml structure
      ; Measured cartesian robot pose (Robot TCP in relation to the base coord sys)
      eki_ret = eki_setreal("EkiHwInterface", "RobotState/Position/@X", $POS_ACT_MES.X)
      eki_ret = eki_setreal("EkiHwInterface", "RobotState/Position/@Y", $POS_ACT_MES.Y)
      eki_ret = eki_setreal("EkiHwInterface", "RobotState/Position/@Z", $POS_ACT_MES.Z)
      eki_ret = eki_setreal("EkiHwInterface", "RobotState/Orientation/@A", $POS_ACT_MES.A)
      eki_ret = eki_setreal("EkiHwInterface", "RobotState/Orientation/@B", $POS_ACT_MES.B)
      eki_ret = eki_setreal("EkiHwInterface", "RobotState/Orientation/@C", $POS_ACT_MES.C)

      ; Send xml structure
      if $flag[1] then  ; Make sure connection hasn't died while updating xml structure
         eki_ret = eki_send("EkiHwInterface", "RobotState")
      endif
   endif
end